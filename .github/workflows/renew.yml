name: Katabump Auto Renew

on:
  schedule:
    # 计划任务：每 3 天的 UTC 时间 02:00 运行一次
    # (对应北京时间上午 10:00)
    - cron: '0 2 */3 * *'
  workflow_dispatch: # 允许手动点击按钮测试

jobs:
  renew_job:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code (拉取代码)
        uses: actions/checkout@v3

      - name: Set up Python (设置环境)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Chrome (安装浏览器)
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Install Dependencies (安装依赖)
        run: |
          pip install -r requirements.txt

      - name: Run Renew Script (运行脚本)
        env:
          # 注入 GitHub Secrets
          DISCORD_COOKIE_STRING: ${{ secrets.DISCORD_COOKIE_STRING }}
          DISCORD_EMAIL: ${{ secrets.DISCORD_EMAIL }}
          DISCORD_PASSWORD: ${{ secrets.DISCORD_PASSWORD }}
        run: |
          # 配置虚拟显示器以提高无头浏览器的稳定性
          export DISPLAY=:99
          sudo Xvfb -ac :99 -screen 0 1280x1024x16 > /dev/null 2>&1 &
          # 运行 Python 脚本
          python main.py
      
      # 如果脚本运行失败，上传截图以便排查
      - name: Upload Debug Screenshot
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: '*.jpg'
